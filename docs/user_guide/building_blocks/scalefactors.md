# Scalefactors and uncertainties in columnflow

## theory uncertainties
Theory uncertainties discussed below are pdf, scale-variation, and parton-shower uncertainties. These uncertainties require the weight variations for each uncertainty to be normalized by the sum of all weights of that variation for a sample. Therefore in `cf.SelectEvents` the producer `event_weights_to_normalize` in [production/weights.py](https://github.com/GhentAnalysis/columnflow/blob/2a24ab1017d55503d9b485ca56cdb28b767a250d/analysis_templates/ghent_template/__cf_module_name__/production/weights.py#L33C5-L33C31) is called and the sum of weights of each variation is stored in [selection stats](https://github.com/GhentAnalysis/columnflow/blob/2a24ab1017d55503d9b485ca56cdb28b767a250d/analysis_templates/ghent_template/__cf_module_name__/selection/stats.py#L57-L71). These selection stats are later combined over sample files in ´cf.MergeSelectionStats´. The event weight for each theory uncertainty variantions are only produced in ´cf.ProduceColumns´ using a helper function [normalized_weight_factory](https://github.com/GhentAnalysis/columnflow/blob/2a24ab1017d55503d9b485ca56cdb28b767a250d/analysis_templates/ghent_template/__cf_module_name__/production/normalized_weights.py#L22). The helper function creates a `producer` for each uncertainty in [weights.py](https://github.com/GhentAnalysis/columnflow/blob/2a24ab1017d55503d9b485ca56cdb28b767a250d/analysis_templates/ghent_template/__cf_module_name__/production/weights.py#L82-L96) that can produce normalized weights for each uncertainty variation. These producers are then called in [event_weights](https://github.com/GhentAnalysis/columnflow/blob/2a24ab1017d55503d9b485ca56cdb28b767a250d/analysis_templates/ghent_template/__cf_module_name__/production/weights.py#L110).
### pdf uncertainties
PDF uncertainties are calculated in [columnflow/production/cms/pdf.py](https://github.com/GhentAnalysis/columnflow/blob/scalefactor-development/columnflow/production/cms/pdf.py) and uses NanoAOD column `LHEPdfWeight`. The column `LHEPdfWeight` should have either 101 or 103 weights of pdf variations for each event. The nominal pdf variation is the first weight in the list, followed by the weights of 100 pdf variations. The last 2 weights (in available) are the two $α_s$ variations. The pdf weight uncertainty in columnflow is by default calculated as half the width of the central 68% CL and procued in the columns `pdf_weight_{up/down}`. Outliers of >50% uncertainty are removed. The option to store all pdf weights individually in addition to the uncertainty is also possible with attribute `store_all_weights=True`. $α_s$ variations are not yet included in columnflow.

[TOP RECOMMENDATION](https://twiki.cern.ch/twiki/bin/viewauth/CMS/TopSystematics#PDF)

### PS uncertainties
 PS uncertainties are calculated in [columnflow/production/cmsGhent/parton_shower.py](https://github.com/GhentAnalysis/columnflow/blob/2a24ab1017d55503d9b485ca56cdb28b767a250d/columnflow/production/cmsGhent/parton_shower.py#L26) and uses NanoAOD column `PSWeight`. The column `PSWeight` has 4 weights corresponding to up- and down-variations of the renormalization scale for QCD emissions in initial-state and final-state radiation (`ISR=2 FSR=1`, `ISR=1 FSR=2`, `ISR=0.5 FSR=1` and `ISR=1 FSR=0.5`). The PS uncertainties correspond to the up- and down-variation of the renormalization scale for ISR and FSR individually and are saved in the columns `isr_weight_{up/down}` and `fsr_weight_{up/down}` respectively.

[TOP RECOMMENDATION](https://twiki.cern.ch/twiki/bin/viewauth/CMS/TopSystematics#Parton_shower_uncertainties)

### Factorization and renormalization scale uncertainties
 Factorization and renormalization scale uncertainties are calculated in [columnflow/production/cmsGhent/scale.py](https://github.com/GhentAnalysis/columnflow/blob/2a24ab1017d55503d9b485ca56cdb28b767a250d/columnflow/production/cmsGhent/scale.py) and uses NanoAOD column `LHEScaleWeight`. The column `LHEScaleWeight` has 8 weights corresponding to all combinations of the nominal, up and down variation of the factorization and renormalization scale excluding the nominal case. The up- and down- variation of factorization scale, normalization scale, and the combination of the two are the uncertainties produced with the corresponding columns `muf_weight_{up/down}`, `mur_weight_{up/down}`, and `murmuf_weight_{up/down}`.

[TOP RECOMMENDATION](https://twiki.cern.ch/twiki/bin/viewauth/CMS/TopSystematics#Parton_shower_uncertainties)
